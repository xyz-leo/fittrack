name: Release e Versionamento

on:
    pull_request:
        types: [closed]
        branches:
            - main

jobs:
    release:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - name: Checkout do c√≥digo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configurar Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Obter √∫ltima tag
              id: get_latest_tag
              run: |
                  # Busca a √∫ltima tag, se n√£o existir usa v0.0.0
                  LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
                  echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
                  echo "√öltima tag: $LATEST_TAG"

            - name: Determinar tipo de vers√£o
              id: version_type
              run: |
                  PR_TITLE="${{ github.event.pull_request.title }}"
                  PR_LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"

                  # Determina o tipo de vers√£o baseado em labels ou t√≠tulo do PR
                  if echo "$PR_LABELS" | grep -q "major\|breaking"; then
                    echo "bump=major" >> $GITHUB_OUTPUT
                    echo "Tipo: MAJOR (breaking change)"
                  elif echo "$PR_LABELS" | grep -q "feature\|enhancement"; then
                    echo "bump=minor" >> $GITHUB_OUTPUT
                    echo "Tipo: MINOR (nova feature)"
                  else
                    echo "bump=patch" >> $GITHUB_OUTPUT
                    echo "Tipo: PATCH (corre√ß√£o/melhoria)"
                  fi

            - name: Calcular nova vers√£o
              id: new_version
              run: |
                  LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
                  BUMP_TYPE="${{ steps.version_type.outputs.bump }}"

                  # Remove o 'v' do in√≠cio
                  VERSION=${LATEST_TAG#v}

                  # Separa os n√∫meros da vers√£o
                  IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
                  MAJOR=${VERSION_PARTS[0]:-0}
                  MINOR=${VERSION_PARTS[1]:-0}
                  PATCH=${VERSION_PARTS[2]:-0}

                  # Incrementa baseado no tipo
                  if [ "$BUMP_TYPE" == "major" ]; then
                    MAJOR=$((MAJOR + 1))
                    MINOR=0
                    PATCH=0
                  elif [ "$BUMP_TYPE" == "minor" ]; then
                    MINOR=$((MINOR + 1))
                    PATCH=0
                  else
                    PATCH=$((PATCH + 1))
                  fi

                  NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "Nova vers√£o: $NEW_VERSION"

            - name: Gerar notas da release
              id: release_notes
              run: |
                  NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
                  PR_NUMBER="${{ github.event.pull_request.number }}"
                  PR_TITLE="${{ github.event.pull_request.title }}"
                  PR_AUTHOR="${{ github.event.pull_request.user.login }}"
                  PR_BODY="${{ github.event.pull_request.body }}"

                  # Cria as notas da release
                  cat > release_notes.md << EOF
                  ## üöÄ Release $NEW_VERSION

                  ### Altera√ß√µes

                  **PR #$PR_NUMBER**: $PR_TITLE
                  - Autor: @$PR_AUTHOR

                  $PR_BODY

                  ---

                  **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.get_latest_tag.outputs.latest_tag }}...$NEW_VERSION
                  EOF

                  echo "Notas da release geradas"

            - name: Criar tag
              run: |
                  NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
                  git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
                  git push origin "$NEW_VERSION"
                  echo "Tag $NEW_VERSION criada e enviada"

            - name: Criar GitHub Release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ steps.new_version.outputs.new_version }}
                  release_name: Release ${{ steps.new_version.outputs.new_version }}
                  body_path: release_notes.md
                  draft: false
                  prerelease: false

            - name: Atualizar CHANGELOG.md
              run: |
                  NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
                  DATE=$(date +%Y-%m-%d)
                  PR_NUMBER="${{ github.event.pull_request.number }}"
                  PR_TITLE="${{ github.event.pull_request.title }}"
                  PR_AUTHOR="${{ github.event.pull_request.user.login }}"

                  # Cria CHANGELOG.md se n√£o existir
                  if [ ! -f CHANGELOG.md ]; then
                    cat > CHANGELOG.md << EOF
                  # Changelog

                  Todas as mudan√ßas not√°veis neste projeto ser√£o documentadas neste arquivo.

                  O formato √© baseado em [Keep a Changelog](https://keepachangelog.com/pt-BR/1.0.0/),
                  e este projeto adere ao [Semantic Versioning](https://semver.org/lang/pt-BR/).

                  EOF
                  fi

                  # Cria entrada tempor√°ria
                  cat > temp_entry.md << EOF
                  ## [$NEW_VERSION] - $DATE

                  ### Altera√ß√µes
                  - **PR #$PR_NUMBER**: $PR_TITLE ([@$PR_AUTHOR](https://github.com/$PR_AUTHOR))

                  EOF

                  # Insere a nova entrada ap√≥s o cabe√ßalho
                  sed -i '/^O formato √© baseado/a\\n' CHANGELOG.md
                  sed -i "/^O formato √© baseado/r temp_entry.md" CHANGELOG.md

                  # Limpa arquivo tempor√°rio
                  rm temp_entry.md

                  echo "CHANGELOG.md atualizado"

            - name: Commit e push do CHANGELOG
              run: |
                  git add CHANGELOG.md
                  if git diff --staged --quiet; then
                    echo "Nenhuma altera√ß√£o no CHANGELOG"
                  else
                    git commit -m "docs: atualizar CHANGELOG para ${{ steps.new_version.outputs.new_version }} [skip ci]"
                    git push origin main
                    echo "CHANGELOG commitado e enviado"
                  fi

            - name: Comentar no PR
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `üéâ Release **${{ steps.new_version.outputs.new_version }}** criada com sucesso!\n\n‚úÖ Tag criada\n‚úÖ Release publicada\n‚úÖ CHANGELOG atualizado`
                      })
