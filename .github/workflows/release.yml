name: Release e Versionamento

on:
    pull_request:
        types: [closed]
        branches:
            - main

jobs:
    release:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - name: Checkout do cÃ³digo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configurar Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Obter Ãºltima tag
              id: get_latest_tag
              run: |
                  LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
                  echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
                  echo "Ãšltima tag: $LATEST_TAG"

            - name: Determinar tipo de versÃ£o
              id: version_type
              run: |
                  PR_LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"

                  if echo "$PR_LABELS" | grep -qi "major\|breaking"; then
                    echo "bump=major" >> $GITHUB_OUTPUT
                    echo "Tipo: MAJOR (breaking change)"
                  elif echo "$PR_LABELS" | grep -qi "feature\|enhancement"; then
                    echo "bump=minor" >> $GITHUB_OUTPUT
                    echo "Tipo: MINOR (nova feature)"
                  else
                    echo "bump=patch" >> $GITHUB_OUTPUT
                    echo "Tipo: PATCH (correÃ§Ã£o/melhoria)"
                  fi

            - name: Calcular nova versÃ£o
              id: new_version
              run: |
                  LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
                  BUMP_TYPE="${{ steps.version_type.outputs.bump }}"

                  VERSION=${LATEST_TAG#v}
                  IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
                  MAJOR=${VERSION_PARTS[0]:-0}
                  MINOR=${VERSION_PARTS[1]:-0}
                  PATCH=${VERSION_PARTS[2]:-0}

                  if [ "$BUMP_TYPE" == "major" ]; then
                    MAJOR=$((MAJOR + 1))
                    MINOR=0
                    PATCH=0
                  elif [ "$BUMP_TYPE" == "minor" ]; then
                    MINOR=$((MINOR + 1))
                    PATCH=0
                  else
                    PATCH=$((PATCH + 1))
                  fi

                  NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "Nova versÃ£o: $NEW_VERSION"

            - name: Gerar notas da release
              id: release_notes
              env:
                  NEW_VERSION: ${{ steps.new_version.outputs.new_version }}
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
                  PR_AUTHOR: ${{ github.event.pull_request.user.login }}
                  OLD_VERSION: ${{ steps.get_latest_tag.outputs.latest_tag }}
                  REPO: ${{ github.repository }}
              run: |
                  echo "## Release ${NEW_VERSION}" > release_notes.md
                  echo "" >> release_notes.md
                  echo "### Alteracoes" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "PR #${PR_NUMBER}: ${PR_TITLE}" >> release_notes.md
                  echo "- Autor: @${PR_AUTHOR}" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "**Full Changelog**: https://github.com/${REPO}/compare/${OLD_VERSION}...${NEW_VERSION}" >> release_notes.md

            - name: Criar tag
              run: |
                  NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
                  git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
                  git push origin "$NEW_VERSION"

            - name: Criar GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.new_version.outputs.new_version }}
                  name: Release ${{ steps.new_version.outputs.new_version }}
                  body_path: release_notes.md
                  draft: false
                  prerelease: false

            - name: Atualizar CHANGELOG.md
              env:
                  NEW_VERSION: ${{ steps.new_version.outputs.new_version }}
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
                  PR_AUTHOR: ${{ github.event.pull_request.user.login }}
              run: |
                  DATE=$(date +%Y-%m-%d)

                  if [ ! -f CHANGELOG.md ]; then
                    echo "# Changelog" > CHANGELOG.md
                    echo "" >> CHANGELOG.md
                    echo "Todas as mudancas notaveis neste projeto serao documentadas neste arquivo." >> CHANGELOG.md
                    echo "" >> CHANGELOG.md
                    echo "O formato e baseado em Keep a Changelog e este projeto adere ao Semantic Versioning." >> CHANGELOG.md
                    echo "" >> CHANGELOG.md
                  fi

                  echo "" > temp_entry.md
                  echo "## [${NEW_VERSION}] - ${DATE}" >> temp_entry.md
                  echo "" >> temp_entry.md
                  echo "### Alteracoes" >> temp_entry.md
                  echo "- PR #${PR_NUMBER}: ${PR_TITLE} (@${PR_AUTHOR})" >> temp_entry.md
                  echo "" >> temp_entry.md

                  sed -i '/Semantic Versioning/r temp_entry.md' CHANGELOG.md
                  rm temp_entry.md

            - name: Commit e push do CHANGELOG
              run: |
                  git add CHANGELOG.md
                  if ! git diff --staged --quiet; then
                    git commit -m "docs: atualizar CHANGELOG para ${{ steps.new_version.outputs.new_version }} [skip ci]"
                    git push origin main
                  fi

            - name: Comentar no PR
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `ðŸŽ‰ Release **${{ steps.new_version.outputs.new_version }}** criada com sucesso!\n\nâœ… Tag criada\nâœ… Release publicada\nâœ… CHANGELOG atualizado`
                      })
